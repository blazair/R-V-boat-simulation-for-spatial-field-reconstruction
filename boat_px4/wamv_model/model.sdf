<?xml version="1.0"?>
<sdf version="1.9">
  <model name="wamv">
    <pose>0 0 0.15 0 0 0</pose>

    <!-- HULL / BODY -->
    <link name="base_link">
      <self_collide>false</self_collide>

      <!-- Hull mass that worked for floating -->
      <inertial>
        <mass>36.0</mass>
        <pose>0.298 0 -0.12 0 0 0</pose>  <!-- FORWARD, not back -->
        <inertia>
          <ixx>22.0</ixx><ixy>0.0</ixy><ixz>0.0</ixz>
          <iyy>45.0</iyy><iyz>0</iyz>
          <izz>55.0</izz>
        </inertia>
      </inertial>

      <!-- Moderate damping to help stability -->
      <velocity_decay>
        <linear>0.08</linear>
        <angular>0.20</angular>
      </velocity_decay>

      <!-- Visual -->
      <visual name="base_visual">
        <geometry>
          <mesh><uri>model://wamv/meshes/WAM-V-Base.dae</uri></mesh>
        </geometry>
      </visual>

      <!-- LEFT PONTOON - centered -->
      <collision name="pontoon_left">
        <pose>-0.85 0.80 -0.10 0 1.5708 0</pose>   <!-- x moved back; z slightly deeper -->
        <geometry>
          <cylinder>
            <radius>0.12</radius>
            <length>3.2</length>                   <!-- spans from about -2.45 to +0.75 m -->
          </cylinder>
        </geometry>
        <surface>
          <contact>
            <collide_bitmask>0x01</collide_bitmask>
          </contact>
        </surface>
      </collision>

      <!-- RIGHT PONTOON -->
      <collision name="pontoon_right">
        <pose>-0.85 -0.80 -0.10 0 1.5708 0</pose>
        <geometry>
          <cylinder>
            <radius>0.12</radius>
            <length>3.2</length>
          </cylinder>
        </geometry>
        <surface>
          <contact>
            <collide_bitmask>0x01</collide_bitmask>
          </contact>
        </surface>
      </collision>

      <!-- Deck collision - above water -->
      <collision name="deck_collision">
        <pose>0 0 0.35 0 0 0</pose>
        <geometry><box><size>2.5 1.5 0.02</size></box></geometry>
      </collision>

      <!-- SENSORS -->
      <sensor name="imu_sensor" type="imu">
        <always_on>1</always_on>
        <update_rate>250</update_rate>
        <imu>
          <angular_velocity>
            <x><noise type="gaussian"><mean>0</mean><stddev>0.00018665</stddev>
              <dynamic_bias_stddev>3.8785e-05</dynamic_bias_stddev>
              <dynamic_bias_correlation_time>1000</dynamic_bias_correlation_time></noise></x>
            <y><noise type="gaussian"><mean>0</mean><stddev>0.00018665</stddev>
              <dynamic_bias_stddev>3.8785e-05</dynamic_bias_stddev>
              <dynamic_bias_correlation_time>1000</dynamic_bias_correlation_time></noise></y>
            <z><noise type="gaussian"><mean>0</mean><stddev>0.00018665</stddev>
              <dynamic_bias_stddev>3.8785e-05</dynamic_bias_stddev>
              <dynamic_bias_correlation_time>1000</dynamic_bias_correlation_time></noise></z>
          </angular_velocity>
          <linear_acceleration>
            <x><noise type="gaussian"><mean>0</mean><stddev>0.00186</stddev>
              <dynamic_bias_stddev>0.006</dynamic_bias_stddev>
              <dynamic_bias_correlation_time>300</dynamic_bias_correlation_time></noise></x>
            <y><noise type="gaussian"><mean>0</mean><stddev>0.00186</stddev>
              <dynamic_bias_stddev>0.006</dynamic_bias_stddev>
              <dynamic_bias_correlation_time>300</dynamic_bias_correlation_time></noise></y>
            <z><noise type="gaussian"><mean>0</mean><stddev>0.00186</stddev>
              <dynamic_bias_stddev>0.006</dynamic_bias_stddev>
              <dynamic_bias_correlation_time>300</dynamic_bias_correlation_time></noise></z>
          </linear_acceleration>
        </imu>
      </sensor>

      <sensor name="magnetometer_sensor" type="magnetometer">
        <always_on>1</always_on><update_rate>100</update_rate>
        <magnetometer>
          <x><noise type="gaussian"><mean>0</mean><stddev>0.0001</stddev></noise></x>
          <y><noise type="gaussian"><mean>0</mean><stddev>0.0001</stddev></noise></y>
          <z><noise type="gaussian"><mean>0</mean><stddev>0.0001</stddev></noise></z>
        </magnetometer>
      </sensor>

      <sensor name="air_pressure_sensor" type="air_pressure">
        <always_on>1</always_on><update_rate>50</update_rate>
        <air_pressure>
          <pressure><noise type="gaussian"><mean>0</mean><stddev>0.01</stddev></noise></pressure>
        </air_pressure>
      </sensor>

      <sensor name="navsat_sensor" type="navsat">
        <always_on>1</always_on><update_rate>30</update_rate>
      </sensor>
    </link>

    <!-- LEFT ENGINE - Original VRX position (stern) -->
    <link name="left_engine_link">
      <pose relative_to="base_link">-2.373776 1.027135 0.318237 0 0 0</pose>
      <inertial>
        <mass>1.5</mass>
        <inertia>
          <ixx>0.1</ixx><ixy>0</ixy><ixz>0</ixz>
          <iyy>0.12</iyy><iyz>0</iyz>
          <izz>0.08</izz>
        </inertia>
      </inertial>
      <visual name="left_engine_visual">
        <geometry><mesh><uri>model://wamv/meshes/engine.dae</uri></mesh></geometry>
      </visual>
    </link>

    <!-- LEFT PROPELLER - Original VRX offset -->
    <link name="left_propeller_link">
      <pose relative_to="left_engine_link">-0.278156 0 -0.509371 0 0 0</pose>
      <inertial>
        <mass>0.5</mass>
        <inertia>
          <ixx>0.002</ixx><ixy>0</ixy><ixz>0</ixz>
          <iyy>0.002</iyy><iyz>0</iyz><izz>0.003</izz>
        </inertia>
      </inertial>
      <visual name="left_propeller_visual">
        <geometry><mesh><uri>model://wamv/meshes/propeller.dae</uri></mesh></geometry>
      </visual>
    </link>

    <!-- RIGHT ENGINE - Original VRX position (stern) -->
    <link name="right_engine_link">
      <pose relative_to="base_link">-2.373776 -1.027135 0.318237 0 0 0</pose>
      <inertial>
        <mass>1.5</mass>
        <inertia>
          <ixx>0.1</ixx><ixy>0</ixy><ixz>0</ixz>
          <iyy>0.12</iyy><iyz>0</iyz>
          <izz>0.08</izz>
        </inertia>
      </inertial>
      <visual name="right_engine_visual">
        <geometry><mesh><uri>model://wamv/meshes/engine.dae</uri></mesh></geometry>
      </visual>
    </link>

    <!-- RIGHT PROPELLER - Original VRX offset -->
    <link name="right_propeller_link">
      <pose relative_to="right_engine_link">-0.278156 0 -0.509371 0 0 0</pose>
      <inertial>
        <mass>0.5</mass>
        <inertia>
          <ixx>0.002</ixx><ixy>0</ixy><ixz>0</ixz>
          <iyy>0.002</iyy><iyz>0</iyz><izz>0.003</izz>
        </inertia>
      </inertial>
      <visual name="right_propeller_visual">
        <geometry><mesh><uri>model://wamv/meshes/propeller.dae</uri></mesh></geometry>
      </visual>
    </link>

    <!-- JOINTS -->
    <!-- Lock engine pods (no steering for now) -->
    <joint name="left_engine_joint" type="fixed">
      <parent>base_link</parent>
      <child>left_engine_link</child>
    </joint>

    <joint name="right_engine_joint" type="fixed">
      <parent>base_link</parent>
      <child>right_engine_link</child>
    </joint>

    <!-- Propeller joints - spin forward (+X thrust pushes boat forward) -->
    <joint name="left_propeller_joint" type="revolute">
      <parent>left_engine_link</parent>
      <child>left_propeller_link</child>
      <axis>
        <xyz>1 0 0</xyz>
        <limit><lower>-1e16</lower><upper>1e16</upper></limit>
        <dynamics><damping>0.05</damping><friction>0.0</friction></dynamics>
      </axis>
    </joint>

    <joint name="right_propeller_joint" type="revolute">
      <parent>right_engine_link</parent>
      <child>right_propeller_link</child>
      <axis>
        <xyz>1 0 0</xyz>
        <limit><lower>-1e16</lower><upper>1e16</upper></limit>
        <dynamics><damping>0.05</damping><friction>0.0</friction></dynamics>
      </axis>
    </joint>

    <!-- SENSOR PLUGINS -->
    <plugin filename="gz-sim-imu-system" name="gz::sim::systems::Imu"/>
    <plugin filename="gz-sim-magnetometer-system" name="gz::sim::systems::Magnetometer"/>
    <plugin filename="gz-sim-air-pressure-system" name="gz::sim::systems::AirPressure"/>
    <plugin filename="gz-sim-navsat-system" name="gz::sim::systems::NavSat"/>

    <!-- HYDRODYNAMICS - Calm but stable -->
    <plugin filename="gz-sim-hydrodynamics-system" name="gz::sim::systems::Hydrodynamics">
      <link_name>base_link</link_name>
      <water_density>1000</water_density>
      <!-- Linear drag -->
      <xU>-20</xU>
      <yV>-60</yV>
      <zW>-120</zW>
      <!-- Angular drag -->
      <kP>-40</kP>
      <mQ>-50</mQ>
      <nR>-60</nR>
      <!-- Added mass -->
      <xDotU>-2.0</xDotU>
      <yDotV>-4.0</yDotV>
      <nDotR>-1.0</nDotR>
    </plugin>

    <!-- THRUSTERS - Use velocity control mode -->
    <plugin filename="gz-sim-thruster-system" name="gz::sim::systems::Thruster">
      <joint_name>left_propeller_joint</joint_name>
      <namespace>wamv_0</namespace>                 <!-- no leading slash -->
      <topic>command/thrust/left</topic>            <!-- relative to namespace -->
      <use_angvel_cmd>false</use_angvel_cmd>        <!-- commands are Newtons (default) -->
      <thrust_coefficient>0.01</thrust_coefficient>
      <fluid_density>1000</fluid_density>
      <propeller_diameter>0.2</propeller_diameter>
      <velocity_control>true</velocity_control>     <!-- OK: affects how blades spin -->
      <max_thrust_cmd>500</max_thrust_cmd>          <!-- matches your teleop clamp -->
    </plugin>

    <plugin filename="gz-sim-thruster-system" name="gz::sim::systems::Thruster">
      <joint_name>right_propeller_joint</joint_name>
      <namespace>wamv_0</namespace>
      <topic>command/thrust/right</topic>
      <use_angvel_cmd>false</use_angvel_cmd>
      <thrust_coefficient>0.01</thrust_coefficient>
      <fluid_density>1000</fluid_density>
      <propeller_diameter>0.2</propeller_diameter>
      <velocity_control>true</velocity_control>
      <max_thrust_cmd>500</max_thrust_cmd>
    </plugin>

    <!-- Add BEFORE </model> tag -->
    <plugin filename="gz-sim-odometry-publisher-system"
            name="gz::sim::systems::OdometryPublisher">
      <odom_publish_frequency>50</odom_publish_frequency>
      <odom_frame>wamv_0/odom</odom_frame>
      <robot_base_frame>wamv_0/base_link</robot_base_frame>
    </plugin>
  </model>
</sdf>
